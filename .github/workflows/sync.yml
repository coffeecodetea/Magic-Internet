name: Sync Loon Plugin

on:
  schedule:
    - cron: '0 2 * * *'   # UTC 02:00 (北京时间 10:00)
    - cron: '0 7 * * *'   # UTC 07:00 (北京时间 15:00)
    - cron: '0 10 * * *'  # UTC 10:00 (北京时间 18:00)
    - cron: '0 18 * * *'  # UTC 18:00 (北京时间 02:00)
  push:
    branches:
      - source
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3
        with:
          ref: source
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install and Run Sync
        working-directory: ./LoonPlugins
        run: |
          npm install
          node fmz-sync.js

      - name: Deploy to Main Branch
        run: |
          # 配置 Git 用户
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 暂存生成的插件文件和公开版 README
          mkdir -p /tmp/deploy
          cp LoonPlugins/my_block_ads.lpx /tmp/deploy/
          cp LoonPlugins/WeChat_Ads_Merge.lpx /tmp/deploy/
          cp README_public.md /tmp/deploy/README.md

          # 切换到 main 分支 (如果不存在则创建孤儿分支)
          if git ls-remote --exit-code --heads origin main; then
            # 强制回滚 source 分支的本地修改(已保存到 /tmp)，确保 checkout 不会冲突
            git reset --hard
            git checkout main
            git pull origin main
          else
            git checkout --orphan main
            git rm -rf .
          fi

          # 恢复文件结构
          mkdir -p LoonPlugins
          cp /tmp/deploy/my_block_ads.lpx LoonPlugins/
          cp /tmp/deploy/WeChat_Ads_Merge.lpx LoonPlugins/
          cp /tmp/deploy/README.md ./
          
          # 提交并推送
          git add LoonPlugins/my_block_ads.lpx LoonPlugins/WeChat_Ads_Merge.lpx README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update Loon plugin and README [skip ci]" -m "Generated from source commit $(git rev-parse --short source)"
            git push origin main
          fi
